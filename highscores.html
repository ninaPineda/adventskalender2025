<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>Adventskalender</title>
    <link rel="stylesheet" href="style.css" />
    <meta name="theme-color" content="#000000" />
    <style>
      .score-row{
                    display: flex;              /* statt inline-block */
  justify-content: space-between;  /* links + rechts */
  align-items: center;        /* vertikal zentriert */
  border-bottom: 2px;
  border-color: var(--color-main);
  margin-bottom: 1rem;
      }
      .scores-table table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.9rem;
}

.scores-table th,
.scores-table td {
  padding: 0.4rem 0.3rem;
  border-bottom: 1px solid rgba(255,255,255,0.2);
  text-align: left;
}

.scores-table small {
  opacity: 0.7;
  font-size: 0.75em;
}
    </style>
  </head>

  <body>
    <!-- Desktop-Blocker -->
    <div class="desktop-blocker" aria-hidden="true">
      <p>Bitte am Handy √∂ffnen üì±</p>
    </div>

    <header class="site-header">
      <h1 class="adventskalender">Info</h1>
      <div class="coins"></div>
    </header>

    <main class="info-content">
      <div class="info-backdrop"></div>
      <a href="index.html" class="back-button"></a>
      <h1>Bestenliste</h1>
      <div id="scoreList"></div>
    </main>

<script>
  function onScores(data) {
    // Daten vorbereiten: Tag-Nummer + Date-Objekt erg√§nzen
    data = data
      .map(row => {
        const m = row.solved && row.solved.match(/Tag\s+(\d+)/i);
        if (!m) return null;
        const tag = Number(m[1]);
        return {
          ...row,
          tag,
          date: new Date(row.timestamp)
        };
      })
      .filter(Boolean);

    // Nach Zeit sortieren (alt ‚Üí neu), damit wir pro Tag sauber erste/zweite/dritte haben
    data.sort((a, b) => a.date - b.date);

    // pro Tag: Liste der Eintr√§ge in Zeit-Reihenfolge
    const perTag = new Map(); // tag -> [entries...]
    data.forEach(row => {
      if (!perTag.has(row.tag)) perTag.set(row.tag, []);
      perTag.get(row.tag).push(row);
    });

    // Punkte pro Person
    const pointsPerName = {}; // name -> total points
    const scores = [3, 2, 1];

    // Helper: pro Tag Punkte verteilen
    perTag.forEach(entries => {
      const seen = new Set();
      const unique = [];
      for (const e of entries) {
        const name = e.name || "Unbekannt";
        if (!seen.has(name)) {
          seen.add(name);
          unique.push(e);
        }
      }
      unique.slice(0, 3).forEach((e, i) => {
        const name = e.name || "Unbekannt";
        pointsPerName[name] = (pointsPerName[name] || 0) + scores[i];
      });
    });

    // Leaderboard sortieren
    const leaderboardArr = Object.entries(pointsPerName)
      .sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0]));

    // "Heute" bestimmen: aktueller Tag (1‚Äì24)
    const todayTag = Math.min(new Date().getDate(), 24);
    const todayEntries = (perTag.get(todayTag) || []).slice()
      .sort((a, b) => a.date - b.date);

    // Helper f√ºrs Formatieren
    const fmtTime = d =>
      d.toLocaleTimeString("de-DE", { hour: "2-digit", minute: "2-digit" });

    const wrap = document.getElementById("scoreList");

    // HTML bauen
    wrap.innerHTML = `
      <!-- Gesamt-Bestenliste -->
      <div class="question">
        ${leaderboardArr.length === 0 ? "<p>Noch keine Eintr√§ge ü§∑‚Äç‚ôÄÔ∏è</p>" : leaderboardArr.map(
          ([name, pts], i) => `
          <div class="score-row">
            <strong>
            <span>${i + 1}.</span>
            <span>${name}</span>
            </strong>
            <span>${pts} Punkt${pts === 1 ? "" : "e"}</span>
          </div>
        `).join("")}
      </div>

      <h1>Heute (Tag ${todayTag})</h1>
      <div class="question">
        ${todayEntries.length === 0
          ? "<p>Heute hat noch niemand gel√∂st ‚ú®</p>"
          : todayEntries.map((e, i) => {
              const posScore = i === 0 ? 3 : i === 1 ? 2 : i === 2 ? 1 : 0;
              return `
                <div class="score-row">
                  <strong>${i+1}. ${e.name || "Unbekannt"} </strong>
                  <span>  ${fmtTime(e.date)} Uhr</span>
                </div>
              `;
            }).join("")}
      </div>

      <h1>Alle Tage</h1>
      <div class="question scores-table">
        <table>
          <thead>
            <tr>
              <th>Tag</th>
              <th>1.</th>
              <th>2.</th>
              <th>3.</th>
            </tr>
          </thead>
          <tbody>
            ${[...perTag.keys()].sort((a, b) => b - a).map(tag => {
              const entries = perTag.get(tag).slice().sort((a, b) => b.date - a.date);
              const unique = [];
              const seen = new Set();
              for (const e of entries) {
                const name = e.name || "Unbekannt";
                if (!seen.has(name)) {
                  seen.add(name);
                  unique.push(e);
                }
              }
              const cells = [0,1,2].map(i => {
                const e = unique[i];
                if (!e) return "<td>-</td>";
                return `<td>${e.name}</br> <small>(${fmtTime(e.date)})</small></td>`;
              }).join("");

              const others = unique.slice(3).map(e => e.name).join(", ");
              return `
                <tr>
                  <td>${tag}</td>
                  ${cells}
                  <td>${others || "-"}</td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      </div>
    `;
  }
</script>
<script src="https://script.google.com/macros/s/AKfycbxE2viBiew4764LuIA6OevSyb2h5YNvIHkQEa3ym1BiEn_UftktZenu9XF8P5CVMz-btw/exec?callback=onScores"></script>
  </body>
</html>